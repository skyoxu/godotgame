name: Windows Quality Gate

on:
  workflow_dispatch: {}

jobs:
  quality:
    runs-on: windows-latest
    env:
      GODOT_VERSION: '4.5.1'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Pin .NET SDK/Runtime and export DOTNET_ROOT
        shell: pwsh
        run: |
          $installer = "$HOME/dotnet-install.ps1"
          Invoke-WebRequest -UseBasicParsing -Uri 'https://dot.net/v1/dotnet-install.ps1' -OutFile $installer
          & powershell -NoProfile -ExecutionPolicy Bypass -File $installer -Version 8.0.401 -InstallDir "$HOME/.dotnet"
          & powershell -NoProfile -ExecutionPolicy Bypass -File $installer -Runtime dotnet -Version 8.0.21 -InstallDir "$HOME/.dotnet"
          "DOTNET_ROOT=$HOME/.dotnet" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "$HOME/.dotnet" | Out-File -FilePath $env:GITHUB_PATH -Append -Encoding utf8
          dotnet --info

      - name: Download Godot .NET (GitHub Releases)
        shell: pwsh
        run: |
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          New-Item -ItemType Directory -Force -Path godot | Out-Null
          $zip = "godot/godot.zip"
          $u = "https://github.com/godotengine/godot/releases/download/${env:GODOT_VERSION}-stable/Godot_v${env:GODOT_VERSION}-stable_mono_win64.zip"
          Invoke-WebRequest -UseBasicParsing -Uri $u -OutFile $zip
          Expand-Archive $zip -DestinationPath godot -Force
          $exe = Get-ChildItem godot -Recurse -Filter *win64*.exe | Select-Object -First 1
          if (-not $exe) { throw 'Godot exe not found after download.' }
          "GODOT_BIN=$($exe.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "GODOT_BIN=$($exe.FullName)"

      - name: Install Export Templates (GitHub Releases)
        shell: pwsh
        run: |
          [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12
          $tpz = "godot/export_templates.tpz"
          $u = "https://github.com/godotengine/godot/releases/download/${env:GODOT_VERSION}-stable/Godot_v${env:GODOT_VERSION}-stable_export_templates.tpz"
          Invoke-WebRequest -UseBasicParsing -Uri $u -OutFile $tpz
          $temp = "godot/templates_unpacked"
          Expand-Archive $tpz -DestinationPath $temp -Force
          $ver = "${env:GODOT_VERSION}.stable.mono"
          $dst1 = Join-Path $env:APPDATA ("Godot/templates/$ver")
          $dst2 = Join-Path $env:APPDATA ("Godot/export_templates/$ver")
          New-Item -ItemType Directory -Force -Path $dst1,$dst2 | Out-Null
          Copy-Item -Recurse -Force "$temp/*" $dst1
          Copy-Item -Recurse -Force "$temp/*" $dst2
          Write-Host "Templates installed: $dst1 and $dst2"
          $check1 = Join-Path $dst1 'windows_release_x86_64.exe'
          $check2 = Join-Path $dst1 'windows_debug_x86_64.exe'
          if (-not (Test-Path $check1) -or -not (Test-Path $check2)) { Write-Error "Export templates not complete under $dst1" }

      - name: Prewarm & Build Solutions
        shell: pwsh
        run: |
          $env:Path = "$HOME\.dotnet;" + $env:Path
          & "$env:GODOT_BIN" --headless --path . --quit
          & "$env:GODOT_BIN" --headless --path . --build-solutions --quit

      - name: Dotnet tests
        shell: pwsh
        run: ./scripts/ci/run_dotnet_tests.ps1 -Solution 'Game.sln'

      - name: GdUnit4 tests
        shell: pwsh
        run: |
          $env:Path = "$HOME\.dotnet;" + $env:Path
          ./scripts/ci/run_gdunit_tests.ps1 -GodotBin "$env:GODOT_BIN"

      - name: Headless smoke
        shell: pwsh
        run: ./scripts/ci/smoke_headless.ps1 -GodotBin "$env:GODOT_BIN" -TimeoutSec 5

      - name: Export Windows EXE
        shell: pwsh
        run: |
          $env:Path = "$HOME\.dotnet;" + $env:Path
          ./scripts/ci/export_windows.ps1 -GodotBin "$env:GODOT_BIN" -Output build/Game.exe

      - name: Smoke EXE
        shell: pwsh
        run: ./scripts/ci/smoke_exe.ps1 -ExePath build\Game.exe -TimeoutSec 5

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            build/Game.exe
            logs/ci/**

